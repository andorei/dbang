# hedwig. Отправка файлов (и не только) по почте

	версия 0.3

Утилита `hedwig` умеет формировать электронные письма и отправлять их адресатам, согласно спецификации в конфиг-файле. Письма могут быть как текстовые (`text/plain`), так и в формате html (`text/html`), и могут содержать прикрепленные файлы.

* [Как это работает](#как-это-работает)
* [Тело письма](#тело-письма)
* [Прикрепленные файлы](#прикрепленные-файлы)
* [Письма на основе содержания файлов](#письма-на-основе-содержания-файлов)
* [Аргументы командной строки](#аргументы-командной-строки)
* [Параметры конфиг-файла](#параметры-конфиг-файла)
* [Параметры спецификации](#параметры-спецификации)

## Как это работает

Ниже пример минималистичных спецификаций для отправки сообщений `Hello world!` в текстовом и html форматах. Формат явно задается с помощью расширения имени спецификации:

```
specs = {
    ...
    "helloworld.txt": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} hello world",
            "body": "Hello world!"
        },
        "force": True
    },
    "helloworld.html": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} hello world",
            "body": "&lt;html>&lt;body&gt;&lt;p&gt;Hello world!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"
        },
        "force": True
    },
    ...
}
```

Если добавить эти спецификации в тестовый конфиг-файл `hedwig-test.py` и выполнить их, то получим письма следующего содержания:

```
Hello!

Hello world!

Have a good day!
dbang Utilities
```

Приветствие и подпись были добавлены автоматически. Они задаются в конфиг-файле глобальными переменными `TEXT_GREEETING` и `TEXT_SIGNATURE` – для текстовых писем – и `HTML_GREEETING` и `HTML_SIGNATURE` – для писем в формате html.

Приветствие и подпись в письме можно переопределить непосредственно в спецификации. А также добавить пару слов перед подписью с помощью параметра `"finally"`:

```
specs = {
    ...
    "helloworld.txt": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} hello world",
            "greeting": "Салют!\n\n",
            "body": [
                "Hello world!",
                "\nЖду ответа как соловей лета.\n"
            ],
            "signature": "\n\nПока :)\n"
        },
        "force": True
    },
    ...
}
```

В результате получим:

```
Салют!

Hello world!

Жду ответа как соловей лета.

Пока :)
```

Параметр `"force": True` в спецификации нужен для безусловной отправки письма.

Дело в том, что основное назначение и занятие `hedwig` состоит в отправке по почте файлов, созданных утилитами `ddiff`, `dtest`, `dput`. (Само собой, можно отправлять и файлы, созданные другими средствами.) Если файл уже был отправлен, то повторное выполнение спецификации не приводит к его повторной отправке – `hedwig` запоминает время модификации отправленного файла и отправит его снова только после его обновления.

Так, если [утилита `dtest`](dtest.ru.md) формирует файл с отчетом один раз в сутки, а `hedwig` запускается ежечасно и выполняет все спецификации конфиг-файла, то письмо с отчетом от `dtest` будет отправлено только один раз в течение суток – когда файл с отчетом обновится.

Чтобы отправить письмо безусловно и нужен параметр `"force": True`. Такой же эффект дает запуск `hedwig` с [ключом командной строки](#аргументы-командной-строки) `-f` или `--force`.

## Тело письма

Пример спецификаций для формирования тела письма из текстового файла и файла `html`:

```
import os
import sys

OUT_DIR = os.path.join(os.path.dirname(__file__), '..', 'out')
...

specs = {
    ...
    "file.txt": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} file.txt",
            "body": {
                "file": os.path.join(OUT_DIR, 'test.txt')
            }
        }
    },
    "file.html": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} file.html",
            "body": {
                "file": os.path.join(OUT_DIR, 'test.html')
            }
        }
    },
    ...
}
```

Это спецификации из тестового конфиг-файла `hedwig-test.py`. Выполните их и проверьте результат в вашем почтовом ящике.

Параметр `"body"` спецификации позволяет задать тело письма

* как текст – значением типа `str`, см. пример письма `Hello world!`,
* как файл – словарем (dict) с ключом `"file"`, см. пример выше,
* как комбинацию текстов и файлов – списком (list) строк и словарей.

Пример спецификации, где тело письма составляется из текста и содержимого файла:

```
import os
import sys

OUT_DIR = os.path.join(os.path.dirname(__file__), '..', 'out')

TEXT_GUADEAMUS = """Gaudeamus igitur,
iuvenes dum sumus,
gaudeamus igitur,
iuvenes dum sumus.
Post iucundam iuventutem
post molestam senectutem,
nos habebit humus,
nos habebit humus.
"""

...

specs = {
    ...
    "text and file.txt": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} text and file.txt",
            "body": [
                TEXT_GUADEAMUS,
                {"file": os.path.join(OUT_DIR, 'test.txt')}
             ]
        }
    },
    ...
}
```

Обратите внимание, что письмо по этой спецификации будет отправлено только один раз. Повторные выполнения спецификации не приведут к повторной отправке письма, пока файл `TEST_TEXT_FILE` не будет обновлен.

Если же вы хотите отправить письмо безусловно, используйте параметр спецификации `"force": True` или [ключ командной строки](#аргументы-командной-строки) `-f` или `--force`.

Описание файла, содержимое которого вставляется в тело письма, может содержать следующие параметры:

* `"file"` – путь к файлу или [glob-паттерн](https://docs.python.org/3/library/glob.html) для многих файлов,
* `"encoding"` – (опционально) кодировка файла, отличная от заданной глобальной переменной `ENCODING`,
* `"tail"` – (опционально) `True` - брать из текстового файла, например, лог-файла, только новые строки, добавленные после предыдущего запуска утилиты; `False` - брать все строки файла,
* `"clip"` – (опционально) регулярное выражение Python для выделения фрагментов из содержимого файла (после применения `"tail"`), прочее содержимое игнорируется,
* `"substitutions"` – (опционально) список пар `(<паттерн>, <замена>)` для выполнения замен в содержимом файла (после применения `"clip"`).

## Прикрепленные файлы

Файл, или список файлов, которые необходимо прикрепить к письму, чтобы отправить как вложения, можно указать с помощью параметра спецификации `"attachments"`.

Вот пример спецификации письма с прикрепленными файлами:

```
import os
import sys

IN_DIR = os.path.join(os.path.dirname(__file__), '..', 'in')

TEST_CSV_FILE = os.path.join(IN_DIR, 'test.csv')
TEST_XLSX_FILE = os.path.join(IN_DIR, 'test.xlsx')

...

specs = {
    ...
    "with attachments.txt": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} with attachments.txt",
            "body": "See attached files.",
            "attachments": [
                {
                    "file": TEST_CSV_FILE,
                    "MIME": "text/csv",
                    "filename": "countries.csv"
                },
                {
                    "file": TEST_XLSX_FILE,
                    "MIME": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "filename": "countries.xlsx"
                },
            ]
        }
    },
    ...
}
```

В словаре (dict), описывающем прикрепляемый файл,

* `"file"` задает путь к файлу или [glob-паттерн](https://docs.python.org/3/library/glob.html) для многих файлов,
* `"MIME"` опционально описывает формат файла,
* `"filename"` опционально задает имя, под которым файл будет прикреплен к письму.

Имеет смысл указывать `"filename"`, если это имя отличается от имени прикрепляемого файла, как в приведенном примере.

В тестовом конфиг-файле `hedwig-test.py` вы найдете комментарии к каждому из параметров спецификации. Познакомьтесь с ними, чтобы составить исчерпывающее представление обо всех параметрах и их назначении.

## Письма на основе содержания файлов

Все утилиты `dbang` пишут в лог-файлы сообщения в одинаковом формате.

Вот фрагмент лог-файла утилиты `dput` с сообщение об ошибке:

```
2025-01-09 13:19:35,086:INFO:25544:-- start dput.py conf\dput_xxx zzz
2025-01-09 13:19:35,154:INFO:25544:C:\devel\data\zzz.csv
2025-01-09 13:19:35,159:INFO:25544:Loaded 249 of 249 rows with iload=48
2025-01-09 13:19:35,164:ERROR:25544:EXCEPT
Traceback (most recent call last):
  File "C:\devel\dbang\dput.py", line 708, in process
    assert file_ext in ('csv', 'xlsx', 'json', 'zip'), \
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: Bad file extension "dat" in spec "special_zzz"
2025-01-09 13:19:35,185:INFO:25544:-- done  WITH 1 ERRORS
```

Следующая спецификация позволяет найти ошибки во всех лог-файлах в директории `LOG_DIR` и отправить их письмом по электронной почте:

```
import os
import sys

LOG_DIR = os.path.join(os.path.dirname(__file__), '..', 'log')

...

specs = {
	...
    "logged errors.html": {
        "mail": {
            "to": "me@my.self",
            "subject": "{dbang} logged errors.html",
            "body": [
                {
                    "file": os.path.join(LOG_DIR, '????-??-??_*.log'),
                    "tail": True,
                    # find all ERROR reports
                    "clip": r'^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d,\d\d\d:ERROR:[^\n]*\n(?:(?!\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d,\d\d\d:)[^\n]*\n)*',
                    "substitutions": [
                        (r'(.+)', '<code><pre>\n\\1\n</pre></code>')
                    ],
                }
             ],
        }
    },
    ...
}
```

Обратите внимание, что параметр `"tail": True` в предписывает утилите `hedwig`при каждом запуске рассматривать в файлах только новые строки, добавленные после прошлого запуска. Таким образом, при периодическом выполнении данной спецификации адресат будет получить уведомления только о новых возникающих ошибках.

## Аргументы командной строки

```
$ ./hedwig.py -h
usage: hedwig.py [-h] [-f] [-v] cfg_file [spec]

Create email message and send it to addressees, as specified in cfg-file spec.

positional arguments:
  cfg_file       cfg-file name
  spec           spec name, defaults to "all"

options:
  -h, --help     show this help message and exit
  -f, --force    send email unconditionally
  -v, --version  show program's version number and exit

Thanks for using hedwig.py!
```

Обязательно только имя конфиг-файла `cfg_file`.

Если задано имя спецификации `spec`, то выполняется указанная спецификация. Иначе – все спецификации из конфиг-файла.

Ключ `-f` или `--force` предписывает утилите `hedwig` сформировать и отправить электронное письмо даже в том случае, если письмо на основе файлов, указанных в спецификации, уже было сформировано и отправлено.

## Параметры конфиг-файла

Параметры конфиг-файла суть переменные с именами в верхнем регистре, задающие контекст для выполнения спецификаций из данного конфиг-файла. См. также [Структура конфиг-файлов](conf.ru.md).

Параметры конфиг-файла для `hedwig` приведены ниже.

| Параметр          | Значение по умолчанию                                  | Описание                                       |
| ----------------- | ------------------------------------------------------ | ---------------------------------------------- |
| `DEBUGGING`       | `False`                                                | Режим отладки?                                 |
| `LOGGING`         | = DEBUGGING                                            | Писать в лог-файл?                             |
| `LOG_DIR`         | `./`                                                   | Директория для лог-файлов.                     |
| `DATETIME_FORMAT` | `"%Y-%m-%d %H:%M:%S%z"`                                | Формат даты и времени, по умолчанию ISO 86101. |
| `DATE_FORMAT`     | `"%Y-%m-%d"`                                           | Формат даты, по умолчанию ISO 86101.           |
| `ENCODING`*       | `locale.getpreferredencoding()`                        | Кодировка файлов.                              |
| `HTML_GREETING`*  | `<p>Hello!</p><p/>`                                    | Приветствие для писем в формате `html`.        |
| `HTML_SIGNATURE`* | `<p/><p>Have a good day!<br/>dbang Utilities<br/></p>` | Подпись для писем в формате `html`.            |
| `TEXT_GREETING`*  | `"\nHello!\n\n"`                                       | Приветствие для писем в текстовом формате.     |
| `TEXT_SIGNATURE`* | `"\n\nHave a good day!\ndbang Utilities\n`             | Подпись для писем в текстовом формате.         |
| `MAIL_SERVER`     |                                                        | Адрес SMTP-сервера.                            |
| `MAIL_FROM`       |                                                        | Е-мейл адрес отправителя.                      |
\* параметр конфиг-файла, помеченный звездочкой, на уровне спецификации может быть переопределен соответствующим параметром спецификации.

## Параметры спецификации

Спецификации находятся в конфиг-файле в словаре (dict) `specs` и содержат  **параметры спецификации**. См. также [Структура конфиг-файлов](conf.ru.md).

Параметры спецификации для `hedwig` приведены ниже. Если специально не оговорено, то параметр спецификации является необязательным и может быть опущен.

| Параметр спецификации | Описание                                                                                                                                                              |
| --------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `"tags"`              | Список (list) тегов для выбора данной спецификации в командной строке.                                                                                              |
| `"doc"`               | Краткое описание/комментарий к спецификации.                                                                                                                          |
| `"force"`             | Формировать и отправлять письмо безусловно.                                                                                                                           |
| `"template"`          | Jinja2 шаблон для формирования тела письма. По умолчанию используются шаблоны `hedwig.text.jinja` для текстовых писем и `hedwig.html.jinja` для писем формата `html`. |
| **`"mail"`**          | Словарь (dict), содержащий свойства письма.                                                                                                                         |
| **`mail["to"]`**      | **ОБЯЗАТЕЛЬНЫЙ** е-мейл адрес "Кому", строка (str) или список (list) строк.                                                                                       |
| `mail["cc"]`          | е-мейл адрес "Копия", строка (str) или список (list) строк.                                                                                                       |
| `mail["bcc"]`         | е-мейл адрес "Скрытая копия", строка (str) или список (list) строк.                                                                                               |
| **`mail["subject"]`** | **ОБЯЗАТЕЛЬНАЯ** тема письма (str).                                                                                                                                 |
| `mail["greeting"]`    | Приветствие (str).                                                                                                                                                  |
| **`mail["body"]`**    | **ОБЯЗАТЕЛЬНОЕ** тело письма, см. [Тело письма](#тело-письма).                                                                                                        |
| `mail["signature"]`   | Подпись (str).                                                                                                                                                      |
| `mail["attachments"]` | Список (list) вложенных файлов, см. [Прикрепленные файлы](#прикрепленные-файлы).                                                                                    |


