# dget. Выгрузка данных из БД в файл

Утилита `dget` выгружает из БД данные в файлы форматов `csv`, `xlsx`, `json` или`html`, согласно спецификации в конфиг-файле.

Ниже пример спецификаций, где выгружается одна строка с двумя полями. Имя спецификации задает имя файла и его формат:

```
sources['.'] = sources['sqlite-source']

specs = {
    "hello world.csv": {
        "source": ".",
        "query": "select 'Hello world!', 42 from dual",
        "titles": "select 'Привет', 'Ответ' from dual"
    },
    "hello world.xlsx": {
        "source": ".",
        "query": "select 'Hello world!'  as hello, 42 as answer from dual"
    },
    "hello world.json": {
        "source": ".",
        "query": "select 'Hello world!', 42 from dual",
        "titles": ["Hello", "Answer"]
    },
    "hello world.html": {
        "source": ".",
        "query": "select 'Hello world!', 42 from dual",
        "titles": ["Hello", "Answer"]
    },
    ...
}

sources['sqlite-source']['setup'] = sources['sqlite-source'].get('setup', []) + [
    "create table if not exists dual as select 'X' as dummy"
]

sources['postgres-source']['setup'] = sources['postgres-source'].get('setup', []) + [
    "create table if not exists dual as select 'X' as dummy"
]
```

Необязательный параметр `"titles"` позволяет задать заголовки столбцов,

* либо списком строк, как в спецификации `"hello world.html"`,
* либо запросом к БД, возвращающим строки, как в спецификации `"hello world.csv"`.

Если параметр `"titles"` отсутствует, в качестве заголовков используются алиасы столбцов из запроса `"query"`, как в спецификации `"hello world.xlsx"`.

С помощью утилиты `dget` можно динамически формировать запросы к БД, выполнять их и выгружать в файл их результаты. Если запрос `"query"` из спецификации вернет одно-единственное строковое значение с алиасом `query`, то `dget` интерпретирует это значение как запрос, который необходимо выполнить.

Например, следующий запрос для PostgreSQL формирует запрос для получения количества строк во всех таблицах текущей схемы, имена которых заканчиваются на `_h`:

```
specs = {
    "rowcount.html": {
         "source": "postgres-source",
         "query": """
                select
                    string_agg(
                        'select '''||tablename||''' tablename, count(*) row_count from '||tablename,
                        chr(10)||'union all'||chr(10)
                        order by tablename
                    ) query
                from pg_tables
                where schemaname = current_schema
                    and tablename like '%_h'
                """
        }
```

`dget` выполнит запрос, возвращенный запросом из спецификации, и выведет его результат в файл:

```
select 'bc_h' tablename, count(*) row_count from bc_h
union all
select 'cc_h' tablename, count(*) row_count from cc_h
union all
select 'cn_h' tablename, count(*) row_count from cn_h
union all
select 'emp_h' tablename, count(*) row_count from emp_h
;

tablename row_count
--------- ---------
bc_h         329387
cc_h           2400
cn_h            137
emp_h          1202
```

Если в вашей БД хранятся метаданные, на основании которых можно динамически построить запрос, то описанная возможность вам пригодится.

Файлы форматов `json` и `html` по умолчанию формируются на основе стандартных jinja2-шаблонов `dget.json.jinja` и `dget.html.jinja`, соответственно, расположенных в директории `cfg`. Вы можете создать ваши собственные jinja2-шаблоны, используя те же имена переменных, что в стандартных шаблонах. Для использования вашего шаблона в спецификации задайте его имя параметром спецификации `"template"`.

В тестовом конфиг-файле `dget-test.py` вы найдете комментарии к каждому из параметров спецификации. Познакомьтесь с ними, чтобы составить исчерпывающее представление обо всех параметрах и их назначении.


## Кейс №1 для `dget`

В последние годы на слуху такая вещь, как self-service business intelligence (SSBI), или аналитика самообслуживания. Как это может выглядеть в простейшем случае?

Изо дня в день в ИТ подразделение обращаются из других подразделений с просьбами выгрузить из БД в файл Excel

* все товары категории Обувь сезона весна-лето 23,
* все товары со специальными условиями перевозки,
* новые товары, введенные за последний месяц,
* новые товары, за которые отвечает менеджер Иванова,
* и т.п.

Эти и другие подобные запросы можно удовлетворить одной-единственной выгрузкой товаров, включающей все востребованные атрибуты: категория, сезон, условия перевозки, дата ввода товара, менеджер. Достаточно периодически выгружать данные в файл, доступный заинтересованным сотрудникам, чтобы поток таких запросов в ИТ подразделение иссяк.

Теперь сотрудник, которому нужен список всех товаров категории Обувь сезона весна-лето 2023, просто откроет файл Excel и отфильтрует строки по столбцам "Категория" и "Сезон". И другие пользователи поступят аналогично.

Чтобы организовать периодическую выгрузку данных о товарах, нужно написать спецификацию с SQL запросом и запланировать вызов `dget.py` с данной спецификацией по расписанию (с помощью crontab в Linux или Планировщика заданий в Windows).


## Кейс №2 для `dget`

Выгрузите из БД результат запроса в формате `html` и отправьте адресатам в виде таблички в теле электронного письма.

Это могут быть

* ошибки, зарегистрированные в журнальной таблице за последний час,
* периодический отчет (об активности пользователей, о статусе бизнес-процессов и т.д.),
* уведомление о наступлении некоторого события, которое требует реакции от пользователей.

Если файл с выгруженными данными большой, то вместо вставки данных в тело письма можно прикрепить файл к письму.

Отправка адресатам письма с содержимым html-файла и/или с прикрепленными файлами делается с помощью утилиты `hedwig`.
