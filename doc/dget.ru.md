# dget. Выгрузка данных из БД в файл

	версия 0.3

Утилита `dget` выгружает из БД данные в файлы форматов `csv`, `xlsx`, `json` или`html`, согласно спецификации в конфиг-файле. Выгружаемые данные могут быть записаны в один файл или в серию файлов ограниченного размера. Опционально каждый выходной файл может быть сжат в архив `zip`.

* [Основные возможности](#основные-возможности)
* [Запрос с параметрами](#запрос-с-параметрами)
* [Динамический запрос](#динамический-запрос)
* [Кейс №1](#кейс--1)
* [Кейс №2](#кейс--2)
* [Кейс №3](#кейс--3)
* [Аргументы командной строки](#аргументы-командной-строки)
* [Параметры конфиг-файла](#параметры-конфиг-файла)
* [Параметры спецификации](#параметры-спецификации)

## Основные возможности

Ниже пример спецификаций для SQLite , где выгружаются 1000 строк с двумя полями.

Параметр `"file"` задает имя файла и его формат:

```
# hello-dget.py

SOURCE = sources['sqlite-source']
QUERY = \
	"""
	with recursive numbers (n) as (
		select 0 as n from dual
		union all
		select n + 1
		from numbers
		where n < 999
	)
	select 'Hello world!' as hello,
	    42 as answer
	from numbers
	"""

specs = {
    "hello1": {
        "file": "hello_world.csv",
        "query": QUERY,
        "header": "select 'Привет', 'Ответ' from dual"
    },
    "hello2": {
        "file": "hello_world.xlsx",
        "query": QUERY
    },
    "hello3": {
        "file": "hello_world.json",
        "query": QUERY,
        "header": ["Hello", "Answer"]
    },
    "hello4": {
        "file": "hello_world.html.zip",
        "query": QUERY,
        "header": ["Hello", "Answer"]
    },
    "hello5": {
        "file": "hello_%(user)s_%(datetime)s_%(seqn)06i.csv",
        "rows_per_file": 100,
        "query": QUERY
    },
    ...
}

sources['sqlite-source']['setup'] = sources['sqlite-source'].get('setup', []) + [
    "create table if not exists dual as select 'X' as dummy"
]
```

Параметр `"file"` спецификации `"hello4"` предписывает сформировать файл формата `html` и сжать его в архив `zip`.

Параметр `"file"` спецификации `"hello5"` задает [шаблон в стиле `printf`](https://docs.python.org/3/library/stdtypes.html#printf-style-string-formatting), на основании которого во время выполнения `dget` формируется имя выходного файла. Для подставновки контекстных значений в шаблоне можно использовать следующие имена (в скобках):
* `date` – текущая дата в ISO формате `'%Y-%m-%d`,
* `datetime` – текущие дата и время в формате `'%Y-%m-%d-%H-%M-%S'`:
* `seqn` – номер файла в выгружаемой серии файлов ограниченного размера,
* `user` – имя пользователя, заданного в командной строке с помощью ключа `--user`, или имя пользователя ОС, выполняющего утилиту `dget`.

Параметр `"rows_per_file"` задает количество строк, возвращенных запросом `"query"`, которое записывается в один файл. Так как приведенный запрос возвращает 1000 строк, то в результате выполнения спецификации `"hello5"` будет создано 10 файлов с именами, сформированными по шаблону из параметра `"file"`.

Необязательный параметр `"header"` позволяет задать заголовки полей в выходном файле

* либо списком строк, как в спецификации `"hello4"`,
* либо запросом к БД, возвращающим строки, как в спецификации `"hello1"`.

Если параметр `"header"` отсутствует, в качестве заголовков используются алиасы столбцов из запроса `"query"`, как в спецификации `"hello2"`.

## Запрос с параметрами

Следующая спецификация демонстрирует запрос с параметрами:

```
# hello-dget.py

SOURCE = sources['sqlite-source']

specs = {
	"hello9": {
        "file": "hello_param.csv",
        "query": """
            with recursive numbers (n) as (
		        select 0 as n from dual
		        union all
		        select n + 1
		        from numbers
		        where n < 999
	        )
            select 'Hello '||:name||'!' as hello,
	            :num as answer
	        from numbers
	    """,
        "bind_args": {"name": "world", "num": 42.0}
    }
}
```

Параметр спецификации `"bind_args"` описывает имена связанных переменных (bind variables), используемых в запросе `"query"`, и значения по умолчанию для них. Значения по умолчанию одновременно определяют типы данных, передаваемых в связанные переменные.

Для передачи в запрос аргументов, отличных от заданных по умолчанию, воcпользуйтесь ключом `-a`, или `--arg`, утилиты `dget`:

```
dget.py -a Andrei -a 101 hello-dget hello9
```

Из примера спецификации видно, что для SQLite именованные связанные переменные в запросе SQL обозначаются с помощью двоеточия перед именем переменной. Для других СУБД они могут обозначаться по-другому – это зависит от модуля, реализующего database API для СУБД. Чтобы узнать как, посмотрите тестовые конфиг-файлы `dget-test-sqlite.py`, `dget-test-oracle.py`, `dget-test-mysql.py`.

## Динамический запрос

С помощью утилиты `dget` можно динамически формировать запросы к БД, выполнять их и выгружать в файл их результаты.

Если запрос `"query"` из спецификации вернет одно-единственное строковое значение с алиасом `query`, то `dget` интерпретирует это значение как запрос, который необходимо выполнить.

Например, следующий запрос для PostgreSQL формирует запрос для получения количества строк во всех таблицах текущей схемы, имена которых заканчиваются на `_h`:

```
specs = {
    "rowcount.html": {
         "source": "postgres-source",
         "query": """
                select
                    string_agg(
                        'select '''||tablename||''' tablename, count(*) row_count from '||tablename,
                        chr(10)||'union all'||chr(10)
                        order by tablename
                    ) query
                from pg_tables
                where schemaname = current_schema
                    and tablename like '%_h'
                """
        }
```

`dget` выполнит запрос, возвращенный запросом из спецификации, и выведет его результат в файл:

```
select 'bc_h' tablename, count(*) row_count from bc_h
union all
select 'cc_h' tablename, count(*) row_count from cc_h
union all
select 'cn_h' tablename, count(*) row_count from cn_h
union all
select 'emp_h' tablename, count(*) row_count from emp_h
;

tablename row_count
--------- ---------
bc_h         329387
cc_h           2400
cn_h            137
emp_h          1202
```

Если в вашей БД хранятся метаданные, на основании которых можно динамически построить запрос, то описанная возможность вам пригодится.

Файлы форматов `json` и `html` по умолчанию формируются на основе стандартных jinja2-шаблонов `dget.json.jinja` и `dget.html.jinja`, соответственно, расположенных в директории `cfg`. Вы можете создать ваши собственные jinja2-шаблоны, используя те же имена переменных, что в стандартных шаблонах. Для использования вашего шаблона в спецификации задайте его имя параметром спецификации `"template"`.

В тестовом конфиг-файле `dget-test.py` вы найдете комментарии к каждому из параметров спецификации. Познакомьтесь с ними, чтобы составить исчерпывающее представление обо всех параметрах и их назначении.

## Кейс №1

В последние годы на слуху такая вещь, как self-service business intelligence (SSBI), или аналитика самообслуживания. Как это может выглядеть в простейшем случае?

Изо дня в день в ИТ подразделение обращаются из других подразделений с просьбами выгрузить из БД в файл Excel

* все товары категории Обувь сезона весна-лето 23,
* все товары со специальными условиями перевозки,
* новые товары, введенные за последний месяц,
* новые товары, за которые отвечает менеджер Иванова,
* и т.п.

Эти и другие подобные запросы можно удовлетворить одной-единственной выгрузкой товаров, включающей все востребованные атрибуты: категория, сезон, условия перевозки, дата ввода товара, менеджер. Достаточно периодически выгружать данные в файл, доступный заинтересованным сотрудникам, чтобы поток таких запросов в ИТ подразделение иссяк.

Теперь сотрудник, которому нужен список всех товаров категории Обувь сезона весна-лето 2023, просто откроет файл Excel и отфильтрует строки по столбцам "Категория" и "Сезон". И другие пользователи поступят аналогично.

Чтобы организовать периодическую выгрузку данных о товарах, нужно написать спецификацию с SQL запросом и запланировать вызов `dget.py` с данной спецификацией по расписанию (с помощью crontab в Linux или Планировщика заданий в Windows).

## Кейс №2

Выгрузите из БД результат запроса в формате `html` и отправьте адресатам в виде таблички в теле электронного письма.

Это могут быть

* ошибки, зарегистрированные в журнальной таблице за последний час,
* периодический отчет (об активности пользователей, о статусе бизнес-процессов и т.д.),
* уведомление о наступлении некоторого события, которое требует реакции от пользователей.

Если файл с выгруженными данными большой, то вместо вставки данных в тело письма можно прикрепить файл к письму.

Отправка адресатам письма с содержимым html-файла и/или с прикрепленными файлами делается с помощью утилиты `hedwig`.

## Кейс №3

Используйте утилиту `dget` как бэкенд для веб-приложения, чтобы выгружать из БД данные  в нужном формате.

## Аргументы командной строки

```
$ ./dget.py -h
usage: dget.py [-h] [-v] [-a ARG] [-u USER] [-t] cfg_file [spec] [out_file]

Retrieve data from DB into file, as specified in cfg-file specs.

positional arguments:
  cfg_file              cfg-file name
  spec                  spec name, defaults to "all"
  out_file              output file name

options:
  -h, --help            show this help message and exit
  -v, --version         show program's version number and exit
  -a ARG, --arg ARG     pass one or more arguments to SQL query
  -u USER, --user USER  set username
  -t, --trace           enable tracing

Thanks for using dget.py!
```

Обязательно только имя конфиг-файла `cfg_file`.

Если задано имя спецификации `spec`, то выполняется указанная спецификация. Иначе – все спецификации из конфиг-файла.

Если задано имя выходного файла `out_file`, то данные выгружаются в указанный файл вместо файла, заданного параметром `"file"` спецификации. При этом формат выходного файла определяется по его расширению – так же, как и в случае задания файла параметром `"file"`.

Ключ `-a` или `--arg` позволяет передать один или более аргументов в SQL запрос, заданный параметром спецификации `"query"`. При этом возможные параметры и их значения по умолчанию должны быть заданы параметром спецификации `"bind_args"`.

Ключ `-u` или `--user` позволяет передать имя пользователя, которое будет использовано как часть имени выходного файла. 

Ключ `-t` или `--trace` предписывает утилите `dget` создать трейс-файл в директории `~/.dbang`. Это файл нулевой длины с именем `dget#<spec>#<user>#<timestamp>#<status>`, где `<status>` принимает значения 0 - выполняется, 1 - выполнение завершено успешно, 2 - выполнение завершено с ошибкой.

## Параметры конфиг-файла

Параметры конфиг-файла суть переменные с именами в верхнем регистре, задающие контекст для выполнения спецификаций из данного конфиг-файла. См. также [Структура конфиг-файлов](conf.ru.md).

Параметры конфиг-файла для `dget` приведены ниже.

| Параметр            | Значение по умолчанию                    | Описание                                                     |
| ------------------- | ---------------------------------------- | ------------------------------------------------------------ |
| `DEBUGGING`         | `False`                                  | Режим отладки?                                               |
| `LOGGING`           | = DEBUGGING                              | Писать в лог-файл?                                           |
| `LOG_DIR`           | `./`                                     | Директория для лог-файлов.                                   |
| `OUT_DIR`           | `./`                                     | Директория для выгружаемых файлов.                           |
| `ENCODING`*         | `locale.getpreferredencoding()`          | Кодировка выгружаемых файлов.                                |
| `DATETIME_FORMAT`   | `"%Y-%m-%d %H:%M:%S%z"`                  | Формат даты и времени, по умолчанию ISO 86101.               |
| `DATE_FORMAT`       | `"%Y-%m-%d"`                             | Формат даты, по умолчанию ISO 86101.                         |
| `CSV_DIALECT`*      | `excel`                                  | Диалект `csv`.                                               |
| `CSV_DELIMITER`*    | `csv.get_dialect(CSV_DIALECT).delimiter` | Разделитель полей `csv`.                                     |
| `PRESERVE_N_TRACES` | `10`                                     | Количество сохраняемых трейс-файлов для каждой спецификации. |
| `SOURCE`*           |                                          | Имя источника данных, определенного в файле `sources.py`.    |
\* параметр конфиг-файла, помеченный звездочкой, на уровне спецификации может быть переопределен соответствующим параметром спецификации.

## Параметры спецификации

Спецификации находятся в конфиг-файле в словаре (dict) `specs` и содержат  **параметры спецификации**. См. также [Структура конфиг-файлов](conf.ru.md).

Параметры спецификации для `dget` приведены ниже. Если специально не оговорено, то параметр спецификации является необязательным и может быть опущен.

| Параметр спецификации  | Описание                                                                                                                                                                                                           |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `"tags"`               | Список (list) тегов для выбора данной спецификации в командной строке.                                                                                                                                           |
| `"source"`             | Имя (str) источника данных (далее БД), определенного в файле `sources.py`. Если не задан, то используется параметр конфиг-файла `SOURCE`.                                                                        |
| `"doc"`                | Краткое описание/комментарий к спецификации.                                                                                                                                                                       |
| `"setup"`              | Список (list) предложений SQL для БД, выполняемых в начале выполнения спецификации.                                                                                                                              |
| `"upset"`              | Список (list) предложений SQL для БД, выполняемых при завершении спецификации.                                                                                                                                   |
| **`"file"`**           | **ОБЯЗАТЕЛЬНОЕ** имя файла, в который выгружаются данные. Расширение файла задает формат данных. Имя файла может быть  [glob-паттерном](https://docs.python.org/3/library/glob.html) для серии выгружаемых файлов. |
| `"rows_per_file"`      | Количество (`int`) строк результата запроса к БД, записываемых в один файл – для выгрузки данных в серию файлов небольшого размера.                                                                                |
| **`"query"`**          | **ОБЯЗАТЕЛЬНЫЙ** запрос `select` для БД, возвращающий данные для записи в файл(ы) или динамически сформированный запрос для получения данных (одна строка с одним столбцом с алиасом `query`).                     |
| **`"bind_args"`**      | Словарь (dict) с именами и значениями по умолчанию для связанных (bind) переменных в запросе `"query"`.                                                                                                          |
| `"header"`             | Список (list) имен полей или запрос `select` для БД, возвращающий одну строку с именами полей. Если не задан, то имена полей определяют алиасы столбцов в запросе  `"query"`.                                    |
| `"csv.encoding"`       | Кодировка файла формата `csv`. По умолчанию определяется параметром конфиг-файла `ENCODING`.                                                                                                                       |
| `"csv.dialect"`        | Диалект формата `csv`. По умолчанию определяется параметром конфиг-файла `CSV_DIALECT`.                                                                                                                            |
| `"csv.delimiter"`      | Разделитель полей формата `csv`. По умолчанию определяется параметром конфиг-файла `CSV_DELIMITER`.                                                                                                                |
| `"csv.dec_separator"`  | Десятичный разделитель для чисел в файле формата `csv`. По умолчанию точка.                                                                                                                                        |
| `"json.encoding"`      | Кодировка файла формата `json`. По умолчанию определяется параметром конфиг-файла `ENCODING`.                                                                                                                      |
| `"json.template"`      | Файл шаблона jinja2 для получения файла формата `json`. По умолчанию `dget.json.jinja`.                                                                                                                            |
| `"html.encoding"`      | Кодировка файла формата `html`. По умолчанию определяется параметром конфиг-файла `ENCODING`.                                                                                                                      |
| `"html.template"`      | Файл шаблона jinja2 для получения файла формата `html`. По умолчанию `dget.html.jinja`.                                                                                                                            |
| `"html.title"`         | Заголовок для файла формата `html`. По умолчанию имя спецификации.                                                                                                                                                 |
| `"html.dec_separator"` | Десятичный разделитель для чисел в файле формата `html`. По умолчанию точка.                                                                                                                                       |
