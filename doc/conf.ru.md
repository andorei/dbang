# Структура конфиг-файлов

Конфиг-файлы утилит **dbang**, за исключением `hedwig`, имеют следующую структуру:

```
import os
import sys

from sources import sources

#
# SETTINGS USED BY <utility>
#
# defaults to False
DEBUGGING = True
# defaults to False
LOGGING = True
# defaults to current working directory
OUT_DIR = os.path.join(os.path.dirname(__file__), '..', 'out')
# defaults to current working directory
LOG_DIR = os.path.join(os.path.dirname(__file__), '..', 'log')
# data source
SOURCE = "<source_1>"

#
# SETTINGS USED IN specs
#
# ...

specs = {
    "<spec_1>": {
	    "tags": ["one"],
        ...
    },
    "<spec_2>": {
        "source": "<source_2>",
        ...
    },
    "--<spec_3>": {
	    "tags": ["one", "XXX"],
        ...
    },
}

sources['source_1']['setup'] = sources['source_1'].get('setup', []) + [
    "<SQL statement>"
]

sources['source_2']['setup'] = sources['source_2'].get('setup', []) + [
    "<SQL statement>"
]
```

В конфиг-файлах для `hedwig` не импортируются и не используются определения источников данных из `sources`. В остальном структура конфиг-файлов такая же.

После предложений `import` идет блок параметров, используемых при работе утилиты. Такие параметры приведены в тестовых конфиг-файлах и, как правило, являются полезными, но не обязательными. При их отсутствии утилиты ведут себя по умолчанию.

За блоком параметров идет (опционально) блок пользовательских переменных. Если в спецификациях приходится неоднократно использовать одни и те же выражения или значения, то удобно один раз присвоить их переменным и использовать в спецификациях имена переменных.

Словарь (dict) `specs` содержит спецификации, которые сами являются словарями. Перечень параметров в спецификациях разных утилит и комментарии к ним см. в тестовых конфиг-файлах.

Спецификация, в которой явно не задан параметр `"source"`, использует источник данных, определенный в глобальной переменной `SOURCE`. Такой же подход реализован для ряда других параметров, зависящих от конкретной утилиты.

После спецификаций в конфиг-файле могут быть определены запросы к БД, которые однократно выполняются сразу после установления соединения с БД и непосредственно перед закрытием соединения с БД. Например, если для работы утилиты или для выполнения спецификаций из конфиг-файла нужно, чтобы в БД была создана некоторая таблица или установлены определенные параметры сеанса, то соответствующие команды SQL можно добавить в список `"setup"` источника данных. Если по завершении работы программы нужно удалить созданную в БД таблицу или другой объект, то команды добавляются в список `"upset"`. Примеры можно посмотреть в тестовых конфиг-файлах.

## Управление выполнением спецификаций

Все утилиты `dbang` после пути к конфиг-файлу принимают опциональный параметр с именем спецификации для выполнения. Вместо имени спецификации можно указать один из тегов, определенных в параметре `"tags"` спецификации. Теги позволяют группировать выполнение нескольких спецификаций за один вызов утилиты.

Спецификацию можно "закомментировать", исключив ее выполнение утилитой, если в начале имени спецификации поставить символы `--`.

## Подготовка и завершение выполнения спецификации

Данный раздел относится к конфиг-файлам всех утилит, кроме `hedwig`.

Иногда в начале выполнения спецификации требуется сделать подготовительную работу в БД, например, агрегировать данные во временной таблице, с которой будет работать спецификация. В таком случае поместите необходимые предложения SQL или вызовы процедур в параметр `"setup"` внутри спецификации. См. пример ниже.

Аналогично, иногда требуется выполнить некоторые завершающие действия по окончании работы спецификации. В таком случае поместите необходимые предложения SQL или вызовы процедур в параметр `"upset"` внутри спецификации. См. пример ниже.

```
specs = {
    "<spec_1>": {
	    "setup": "create view myvw as select 3.14 pi",
        ...
	    "upset": "drop view myvw",
    },
    "<spec_2>": {
	    "setup": [
	        "call prepare_data()",
	        """
	        create view my_data as
	        select
	        ...
	        """
	    ],
        ...
	    "upset": [
		    "drop view my_data",
		    "call dismiss_data()"
		],
    },
}
```

Как видно из примера, параметры `"setup"` и `"upset"` могут быть строкой, содержащей единственную команду для БД, или списком (list) строк с командами, которые будут выполняться в порядке их размещения в списке.
