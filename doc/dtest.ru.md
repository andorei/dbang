# dtest. Тестирование качества данных в БД

	версия 0.3

Утилита `dtest` выполняет запросы к БД, указанные в спецификациях конфиг-файла, и формирует отчет о результатах тестирования качества данных в файле формата HTML.

* [Как это работает](#как-это-работает)
* [Аргументы командной строки](#аргументы-командной-строки)
* [Параметры конфиг-файла](#параметры-конфиг-файла)
* [Параметры спецификации](#параметры-спецификации)

## Как это работает

Когда мне нужно убедиться, что в БД нет данных, нарушающих некоторое правило, я пишу запрос, выбирающий данные, нарушающие это правило. Например,

```
-- убедиться, что точка с запятой отсутствует в названиях

select * 
from items 
where name like '%;%'
;
no rows

-- убедиться, что счетчик позиций в заголовке совпадает с числом позиций

select *
from header h
where pos_count != (
    select count(*) from positions p where p.header_id = h.header_id
    )
;
no rows
```

Если запрос не возвращает ничего, это хороший результат.

Если запрос возвращает одну или больше строк данных, значит, правило нарушено и данные требуется скорректировать.

Пример спецификаций для `dtest` с рассмотренными запросами (слегка модифицированными):

```
import os
import sys

from sources import sources


OUT_DIR = os.path.join(os.path.dirname(os.path.realpath(sys.argv[0])), 'out')

specs = {
    "Названия без точки с запятой": {
        "source": "prod",
        "query": """"
            select item_id, name
            from items 
            where name like '%;%'
            """"
    },
    "Счетчик позиций в заголовке": {
        "source": "prod",
        "query": """"
            with q as (
                select header_id, count(*) cnt
                from positions p
                group by header_id
            )
            select h.header_id, h.pos_count, q.cnt
            from header h 
                left join q on q.header_id = h.header_id
            where h.pos_count != coalesce(q.cnt, -1)
            """"
    }
}
```

Глобальная переменная `OUT_DIR` задает директорию, в которой формируется отчет о качестве данных.

В тестовом конфиг-файле `dtest-test.py` вы найдете комментарии к каждому из параметров спецификации. Познакомьтесь с ними, чтобы составить исчерпывающее представление обо всех параметрах и их назначении.

## Аргументы командной строки

```
$ ./dtest.py -h
usage: dtest.py [-h] [-v] cfg_file [spec]

Run queries from cfg-file spec(s) against a DB, and generate data quality report.

positional arguments:
  cfg_file       cfg-file name
  spec           spec name, defaults to "all"

options:
  -h, --help     show this help message and exit
  -v, --version  show program's version number and exit

Thanks for using dtest.py!
```

Обязательно только имя конфиг-файла `cfg_file`.

Если задано имя спецификации `spec`, то выполняется указанная спецификация. Иначе – все спецификации из конфиг-файла.

## Параметры конфиг-файла

Параметры конфиг-файла суть переменные с именами в верхнем регистре, задающие контекст для выполнения спецификаций из данного конфиг-файла. См. также [Структура конфиг-файлов](conf.ru.md).

Параметры конфиг-файла для `dtest` приведены ниже.

| Параметр          | Значение по умолчанию   | Описание                                                  |
| ----------------- | ----------------------- | --------------------------------------------------------- |
| `DEBUGGING`       | `False`                 | Режим отладки?                                            |
| `LOGGING`         | = DEBUGGING             | Писать в лог-файл?                                        |
| `LOG_DIR`         | `./`                    | Директория для лог-файлов.                                |
| `OUT_DIR`         | `./`                    | Директория для файлов отчетов о качестве данных.          |
| `DATETIME_FORMAT` | `"%Y-%m-%d %H:%M:%S%z"` | Формат даты и времени, по умолчанию ISO 86101.            |
| `DATE_FORMAT`     | `"%Y-%m-%d"`            | Формат даты, по умолчанию ISO 86101.                      |
| `SOURCE`*         |                         | Имя источника данных, определенного в файле `sources.py`. |
\* параметр конфиг-файла, помеченный звездочкой, на уровне спецификации может быть переопределен соответствующим параметром спецификации.

## Параметры спецификации

Спецификации находятся в конфиг-файле в словаре (dict) `specs` и содержат **параметры спецификации**. См. также [Структура конфиг-файлов](conf.ru.md).

Параметры спецификации для `dtest` приведены ниже. Если специально не оговорено, то параметр спецификации является необязательным и может быть опущен.

| Параметр спецификации | Описание                                                                                                                                                                                    |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `"tags"`              | Список (list) тегов для выбора данной спецификации в командной строке.                                                                                                                    |
| `"source"`            | Имя (str) источника данных (далее БД), определенного в файле `sources.py`. Если не задан, то используется параметр конфиг-файла `SOURCE`.                                                 |
| `"doc"`               | Краткое описание/комментарий к спецификации, отображаемое в отчете о качестве данных.                                                                                                       |
| `"setup"`             | Список (list) предложений SQL для БД, выполняемых в начале выполнения спецификации.                                                                                                       |
| `"upset"`             | Список (list) предложений SQL для БД, выполняемых при завершении спецификации.                                                                                                            |
| **`"query"`**         | **ОБЯЗАТЕЛЬНЫЙ** запрос `select` для БД, выбирающий строки, нарушающие проверяемое спецификацией условие.                                                                                   |
| `"header"`            | Список (list) заголовков столбцов , возвращаемых запросом `"query"`, в отчете о качестве данных. Если не задан, то заголовки столбцов определяются алиасами столбцов в запросе `"query"`. |
